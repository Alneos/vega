stages:
  - build
  - xbuild
  - test

building:
  stage: build
  image: docker:dind
  tags:
    - docker
    - irt
  variables:
    TEST_IMAGE: gitlab/vegairt
    TEST_CONTAINER: vegairt_oncommit
  before_script:
    - apk add --update --no-cache git
    - env | grep ^DOCKER_     
    - env | grep ^CI_     
    - cat /etc/issue
    - whoami
    - pwd
    - which docker
    - docker info
  script:
    - docker pull ldallolio/vegaci
    - docker build -t $TEST_IMAGE -f Dockerfile_gitlab .
    - docker ps -aq --filter "name=$TEST_CONTAINER" | grep -q . && docker rm -fv $TEST_CONTAINER
    - docker run --name "$TEST_CONTAINER" "$TEST_IMAGE" /bin/sh -c "source /home/vega/.bashrc && ctest ."
    - ls /srv
    - export OUTDIR=$(git show -s --format="%cd_%h" --date=format:'%Y-%m-%d_%H%M' $CI_COMMIT_SHA)
    - mkdir /srv/data/$OUTDIR
    - docker cp $TEST_CONTAINER:/home/vega/vegapp/build/bin/vegapp /srv/data/$OUTDIR    
    - docker rm -f "$TEST_CONTAINER"
    - docker rmi "$TEST_IMAGE"
  artifacts:
    paths:
    - /srv/data/$OUTDIR/vegapp
    expire_in: 1 day

xbuilding:
  stage: xbuild
  image: docker:dind
  tags:
    - docker
    - irt
  variables:
    TEST_IMAGE: gitlab/xvegairt
    TEST_CONTAINER: xvegairt_oncommit
  before_script:
    - apk add --update --no-cache git
    - env | grep ^DOCKER_     
    - env | grep ^CI_     
    - cat /etc/issue
    - whoami
    - pwd
    - which docker
    - docker info
  script:
    - docker pull ldallolio/xvegaci
    - docker build -t $TEST_IMAGE -f Dockerfile_xgitlab .
    - docker ps -aq --filter "name=$TEST_CONTAINER" | grep -q . && docker rm -fv $TEST_CONTAINER
    - docker run --name "$TEST_CONTAINER" "$TEST_IMAGE" "ctest ."
    - ls /srv
    - export OUTDIR=$(git show -s --format="%cd_%h" --date=format:'%Y-%m-%d_%H%M' $CI_COMMIT_SHA)
    - mkdir /srv/data/$OUTDIR
    - docker cp $TEST_CONTAINER:/opt/vega/build/bin/vegapp.exe /srv/data/$OUTDIR    
    - docker rm -f "$TEST_CONTAINER"
    - docker rmi "$TEST_IMAGE"
  artifacts:
    paths:
    - /srv/data/$OUTDIR/vegapp.exe
    expire_in: 1 day    

nightly:
  stage: test
  tags:
    - shell
    - irt
  only:
    - schedules
  before_script:
    - whoami
    - pwd
  script:
    - ls /
